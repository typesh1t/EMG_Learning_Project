# 频域特征详解 - 深度教学材料

## 🌊 为什么需要频域分析？

### 时域 vs 频域
时域特征告诉我们"信号有多强"，频域特征告诉我们"信号由哪些频率组成"。

**类比理解**：
- **时域**：看到一个乐队在演奏 → 只能判断"声音很响"
- **频域**：分析出有吉他、贝斯、鼓 → 知道每种乐器的贡献

### EMG信号的频率特性
```
典型EMG频率范围：
├─ 20-50 Hz：慢肌纤维（Type I，耐力肌）
├─ 50-150 Hz：主要能量区（最重要！）
├─ 150-300 Hz：快肌纤维（Type II，力量肌）
└─ > 300 Hz：高频成分（通常是噪声）
```

---

## 📊 频域特征分类

### 1. 中心频率特征（Central Frequency Features）
描述"频率的平均位置"
- **MNF, MDF**

### 2. 能量分布特征（Power Distribution Features）
描述"能量如何分布在各频段"
- **Total_Power, Peak_Freq, Freq_Ratio**

### 3. 谱矩特征（Spectral Moments）
数学统计量，描述频谱形状
- **SM1, SM2, SM3**

---

## 🔬 每个特征的详细解释

### 1. MNF (Mean Frequency) - 平均频率

#### 数学定义
```
MNF = Σ(f_i × P_i) / Σ(P_i)
```
- f_i: 第i个频率
- P_i: 该频率的功率（FFT幅值平方）

#### 物理意义
- **功率加权的平均频率**
- 类比：班级平均成绩（每个学生成绩 × 权重）
- 反映"频谱的重心位置"

#### 临床意义
**疲劳监测的金标准指标！**

```
非疲劳状态：MNF = 80-120 Hz
↓
持续收缩10秒：MNF = 70-100 Hz（下降10-20%）
↓
疲劳状态：MNF = 50-80 Hz（下降30-40%）
```

**为什么MNF会下降？**
1. **肌肉疲劳** → 乳酸堆积 → pH降低
2. **传导速度变慢** → 动作电位传播变慢
3. **高频运动单元失活** → 只有慢肌纤维还在工作
4. **频谱能量向低频偏移**

#### 应用场景

✅ **职业健康**：
```python
# 监测工人疲劳
每5分钟计算MNF
IF MNF下降 > 20%:
    警告：肌肉疲劳，建议休息
```

✅ **运动训练**：
```
训练前：MNF_baseline = 100 Hz
训练中：实时监测MNF
当MNF < 80 Hz → 训练强度过大，调整方案
```

✅ **康复评估**：
```
正常人：MNF = 90-110 Hz
中风患者：MNF = 60-80 Hz（肌肉功能下降）
康复后：MNF 逐渐恢复到 85-100 Hz
```

---

### 2. MDF (Median Frequency) - 中值频率

#### 数学定义
```
MDF是将功率谱分成两半的频率：
Σ(P_i, i=0 to MDF) = Σ(P_i, i=MDF to end) = Total_Power / 2
```

#### 物理意义
- **功率的"中位数"**
- 50%的能量在MDF以下，50%在MDF以上
- 比MNF更**抗噪声**

#### MDF vs MNF 对比

| 特征 | MNF | MDF |
|------|-----|-----|
| 定义 | 平均值 | 中位数 |
| 对异常值 | 敏感 | 鲁棒 |
| 计算速度 | 快 | 稍慢 |
| 临床应用 | 广泛 | 更可靠 |
| 疲劳敏感度 | 高 | 高 |

**什么时候用MDF？**
- 信号有噪声污染
- 需要更稳定的指标
- 临床研究（发表论文）

**什么时候用MNF？**
- 实时系统（计算更快）
- 信号质量好
- 快速评估

#### 应用案例
```
帕金森病震颤分析：
- 健康人：MDF = 5-8 Hz（生理性震颤）
- 帕金森患者：MDF = 4-6 Hz（静止性震颤）
- 本态性震颤：MDF = 8-12 Hz（动作性震颤）
```

---

### 3. Peak_Freq (Peak Frequency) - 峰值频率

#### 数学定义
```
Peak_Freq = f_max, where P(f_max) = max(P(f))
```
功率谱中**能量最大**的频率点

#### 物理意义
- 信号的**"主频率"**
- 反映主要激活的运动单元类型

#### 应用场景

✅ **肌肉类型识别**：
```
慢肌纤维为主：Peak_Freq = 40-70 Hz
  - 例如：比目鱼肌（姿势维持）

混合型肌肉：Peak_Freq = 70-120 Hz
  - 例如：股四头肌

快肌纤维为主：Peak_Freq = 120-180 Hz
  - 例如：眼外肌（快速运动）
```

✅ **动作识别**：
```
握拳：Peak_Freq = 90-110 Hz
张开手：Peak_Freq = 70-90 Hz
捏取：Peak_Freq = 100-130 Hz（精细动作，快肌参与多）
```

#### 缺点
❌ 对噪声敏感（一个噪声峰值就会污染结果）
❌ 不适合单独使用，应与MNF/MDF配合

---

### 4. Total_Power - 总功率

#### 数学定义
```
Total_Power = Σ(P_i) = Σ(|FFT(x_i)|²)
```

#### 物理意义
- 频域的**总能量**
- 等价于时域的 RMS²
- 反映肌肉**激活的总强度**

#### 与时域特征的关系
```
帕塞瓦尔定理（Parseval's Theorem）：
时域能量 = 频域能量

Σ(x_i²) = Σ(|FFT(x_i)|²)

所以：
Total_Power ≈ RMS² × N
```

#### 应用
✅ **能量监测**：
```
静息：Total_Power < 0.01 mV²
轻度收缩：Total_Power = 0.05-0.1 mV²
最大收缩：Total_Power > 0.5 mV²
```

✅ **归一化参考**：
```python
# 归一化其他频域特征
MNF_normalized = MNF / Total_Power
# 消除幅度影响，只关注频率分布
```

---

### 5. SM1, SM2, SM3 (Spectral Moments) - 谱矩

#### 数学定义
```
第m阶谱矩：
SM_m = Σ(f_i^m × P_i) / Σ(P_i)
```

具体展开：
```
SM1 = Σ(f × P) / Σ(P)  → 实际上就是MNF！
SM2 = Σ(f² × P) / Σ(P)  → 频率的"方差"
SM3 = Σ(f³ × P) / Σ(P)  → 频谱的"偏度"
```

#### 物理意义

**SM1（一阶矩）= MNF**
- 频谱的"平均位置"

**SM2（二阶矩）**
- 频谱的"分散程度"
- SM2高 → 能量分布很宽
- SM2低 → 能量集中在某个频段

**SM3（三阶矩）**
- 频谱的"不对称性"
- SM3 > 0 → 高频尾巴长（快肌激活）
- SM3 < 0 → 低频尾巴长（慢肌为主）

#### 直观理解

想象一个班级的成绩分布：
```
SM1 = 平均分（重心）
SM2 = 分数分散程度（有的90分，有的60分 → SM2大）
SM3 = 分布的偏向（大部分人高分 → 右偏 → SM3 > 0）
```

#### 应用案例

✅ **运动单元招募分析**：
```python
低强度收缩：
  SM2 = 小（只有慢肌，能量集中在50-80Hz）
  SM3 = 负（偏向低频）

高强度收缩：
  SM2 = 大（慢肌+快肌，能量分散在20-200Hz）
  SM3 = 正（快肌参与，高频成分多）
```

✅ **疾病诊断**：
```
肌营养不良：
  - SM2异常升高（运动单元丧失，信号混乱）
  - SM3接近0（频谱对称，缺乏正常的高频成分）
```

---

### 6. Freq_Ratio - 频率比

#### 定义
```
Freq_Ratio = Power_low / Power_high

通常：
Power_low = Σ(P_i, 20-50Hz)
Power_high = Σ(P_i, 50-150Hz)
```

#### 物理意义
- **低频能量 vs 高频能量**
- 反映慢肌纤维与快肌纤维的**相对激活**

#### 应用

✅ **疲劳指标**：
```
非疲劳：Freq_Ratio = 0.3-0.5（高频多）
疲劳中：Freq_Ratio = 0.5-0.8（能量向低频转移）
重度疲劳：Freq_Ratio > 1.0（低频能量超过高频）
```

✅ **肌肉类型鉴别**：
```
腓肠肌（快肌为主）：Freq_Ratio = 0.2-0.4
比目鱼肌（慢肌为主）：Freq_Ratio = 0.6-0.9
```

✅ **训练效果评估**：
```
耐力训练前：Freq_Ratio = 0.5
训练12周后：Freq_Ratio = 0.7（慢肌纤维增加）
```

---

## 🎯 频域特征选择指南

### 疲劳监测（最常用）
```
MDF + MNF + Freq_Ratio
↓
- MDF: 最可靠的疲劳指标
- MNF: 快速计算
- Freq_Ratio: 能量转移的直接证据
```

### 手势分类（假肢控制）
```
Peak_Freq + Total_Power + SM2
↓
- Peak_Freq: 不同手势有不同主频
- Total_Power: 力度控制
- SM2: 捕捉频谱形状差异
```

### 临床诊断（科研）
```
MDF + MNF + SM1 + SM2 + SM3
↓
- 全面的频谱描述
- 适合发表论文
- 统计分析需要
```

### 实时系统（嵌入式）
```
MNF + Peak_Freq
↓
- 计算最快（只需一次FFT）
- 准确率足够（70-80%）
```

---

## 🧮 FFT基础 - 理解频域分析

### 什么是FFT？
```
快速傅里叶变换（Fast Fourier Transform）
作用：将时域信号 → 频域信号

时域：x(t) = [x_1, x_2, ..., x_N]
  ↓ FFT
频域：X(f) = [X_1, X_2, ..., X_N/2]
```

### FFT参数设置

**1. 采样率（fs）的影响**
```
fs = 1000 Hz → 能分析的最高频率 = 500 Hz（Nyquist频率）
fs = 2000 Hz → 能分析的最高频率 = 1000 Hz

EMG推荐：fs ≥ 1000 Hz（覆盖20-500Hz的EMG频段）
```

**2. 窗口长度（N）的影响**
```
频率分辨率 = fs / N

例1：fs=1000Hz, N=1000 → 分辨率 = 1 Hz
  能区分99Hz和100Hz的差异

例2：fs=1000Hz, N=100 → 分辨率 = 10 Hz
  只能区分90Hz和100Hz（太粗糙！）

EMG推荐：N ≥ 256（最好512或1024）
```

**3. 零填充（Zero Padding）**
```python
# 信号太短？用零填充
signal = np.array([...])  # 只有200个点
signal_padded = np.pad(signal, (0, 312), 'constant')  # 填充到512

# 注意：零填充不增加信息，只提高频谱的"平滑度"
```

---

## 💡 实战技巧

### 1. 频域特征的归一化

```python
# ❌ 错误：直接比较不同人的MNF
MNF_user1 = 85 Hz
MNF_user2 = 95 Hz
# 可能只是个体差异，不是真的有区别！

# ✅ 正确：使用相对变化
MNF_baseline = 测量静息时的MNF
MNF_normalized = MNF_current / MNF_baseline
# 现在可以跨个体比较
```

### 2. 频域特征的平滑

```python
# 原始频谱很"毛刺"
PSD_raw = np.abs(np.fft.fft(signal))**2

# 使用Welch方法平滑（推荐）
from scipy import signal as sp_signal
f, PSD_smooth = sp_signal.welch(signal, fs=1000, nperseg=256)

# Welch方法 = 分段FFT + 平均 → 更稳定的频谱
```

### 3. 时频联合分析

```python
# 单独使用时域或频域，准确率有限
# 最佳策略：组合！

# 时域特征（10个）+ 频域特征（8个）= 18个特征
features = np.concatenate([
    time_features,   # MAV, RMS, WL, ...
    freq_features    # MNF, MDF, SM1, ...
])

# 分类准确率：
# 仅时域：75-80%
# 仅频域：70-75%
# 时频联合：85-95% ✅
```

---

## 🧪 课堂练习

### 练习1：频域特征计算

给定功率谱：
```
频率(Hz): [0,  10,  20,  30,  40,  50]
功率(mV²): [0.1, 0.2, 0.5, 0.4, 0.2, 0.1]
```

手工计算：
1. MNF = ?
2. Total_Power = ?
3. MDF ≈ ?（提示：累计功率到一半）

### 练习2：疲劳检测设计

你需要开发一个**实时疲劳监测手环**：
- 目标：检测肌肉疲劳，提醒休息
- 要求：延迟 < 1秒，嵌入式系统
- 准确率：> 85%

你会选择哪些频域特征？为什么？
如何设置阈值？

### 练习3：案例分析

患者B在持续握力测试中，MDF变化如下：
```
0s:  MDF = 95 Hz
30s: MDF = 85 Hz
60s: MDF = 75 Hz
90s: MDF = 72 Hz（变化变慢）
```

问题：
1. 这说明了什么生理现象？
2. 为什么60s后MDF下降变慢？
3. 如果是健康人，MDF应该如何变化？

---

## 📊 频域特征可视化指南

### 1. 功率谱图（PSD）
```python
import matplotlib.pyplot as plt
from scipy import signal

# 计算功率谱
f, Pxx = signal.welch(emg_signal, fs=1000, nperseg=256)

# 绘制
plt.figure(figsize=(10, 4))
plt.semilogy(f, Pxx)  # 使用对数刻度
plt.xlabel('频率 (Hz)')
plt.ylabel('功率谱密度 (mV²/Hz)')
plt.title('EMG功率谱')
plt.grid(True)
plt.xlim(0, 500)  # EMG有效频段
plt.axvline(MNF, color='r', label=f'MNF={MNF:.1f}Hz')
plt.axvline(MDF, color='g', label=f'MDF={MDF:.1f}Hz')
plt.legend()
```

### 2. 时频图（Spectrogram）
```python
# 显示频率如何随时间变化（疲劳监测必备！）
f, t, Sxx = signal.spectrogram(emg_signal, fs=1000, nperseg=256)

plt.figure(figsize=(12, 6))
plt.pcolormesh(t, f, 10*np.log10(Sxx), shading='gouraud')
plt.ylabel('频率 (Hz)')
plt.xlabel('时间 (秒)')
plt.title('EMG时频图 - 观察频谱随时间的变化')
plt.colorbar(label='功率 (dB)')
plt.ylim(0, 300)
```

### 3. 疲劳曲线
```python
# 绘制MDF随时间下降
time_windows = [0, 10, 20, 30, 40, 50]
MDF_values = [95, 90, 85, 78, 74, 72]

plt.figure(figsize=(10, 5))
plt.plot(time_windows, MDF_values, 'o-', linewidth=2)
plt.xlabel('时间 (秒)')
plt.ylabel('MDF (Hz)')
plt.title('肌肉疲劳监测：MDF随时间下降')
plt.grid(True)
plt.axhline(80, color='r', linestyle='--', label='疲劳阈值')
plt.legend()
```

---

## 🔬 进阶话题

### 1. 短时傅里叶变换（STFT）vs 小波变换（Wavelet）

**STFT**：
- 固定窗口大小
- 时频分辨率固定
- 适合稳态信号分析

**小波变换**：
- 可变窗口大小
- 低频用大窗口，高频用小窗口
- 适合瞬态信号（如心电图的QRS波）

EMG推荐：**STFT即可**（Welch方法）

### 2. 自回归模型（AR）特征

除了FFT，还可以用自回归模型估计频谱：
```python
from spectrum import arburg

# AR模型阶数通常选4-8
ar_coeffs, sigma = arburg(signal, order=6)
# 从AR系数可计算频谱
```

优点：
- 更平滑的频谱
- 适合短信号

缺点：
- 需要选择阶数
- 计算稍慢

### 3. 高阶统计量（HOS）

```python
# 双谱（Bispectrum）- 捕捉非线性特性
# EMG信号的非高斯性和非线性耦合
from scipy.signal import bicoherence
```

适用于：
- 复杂的神经肌肉疾病
- 科研前沿

---

## 📚 经典论文推荐

### 必读文献

1. **Lindstrom et al. (1970)**
   - "Interpretation of myoelectric power spectra"
   - 首次系统研究EMG频谱与肌肉疲劳
   - 引用量 > 1000

2. **De Luca (1984)**
   - "Myoelectrical manifestations of localized muscular fatigue"
   - MDF/MNF下降的生理机制
   - EMG疲劳分析的圣经

3. **Phinyomark et al. (2012)**
   - "Feature reduction and selection for EMG signal classification"
   - 系统比较40+种EMG特征
   - 包括时域、频域、时频域

### 数据集资源

- **Ninapro Database**（www.ninapro.hevs.ch）
  - 50+受试者，52种手势
  - 多通道EMG
  - 假肢控制研究标准数据集

- **PhysioNet EMG Database**
  - 免费开放
  - 包含健康人和患者数据

---

## 🎓 学习检查清单

完成本节后，你应该能够：

- [ ] 理解为什么需要频域分析
- [ ] 解释MNF、MDF、Peak_Freq的物理意义
- [ ] 理解谱矩（SM1-3）的含义
- [ ] 用MDF/MNF监测肌肉疲劳
- [ ] 选择合适的FFT参数（fs、窗口长度）
- [ ] 组合时域和频域特征提高分类准确率
- [ ] 绘制功率谱和时频图
- [ ] 理解Freq_Ratio反映的生理信息

---

## 🌟 总结：时域 vs 频域特征

| 维度 | 时域特征 | 频域特征 |
|------|---------|---------|
| **信息类型** | 幅度、能量、波动 | 频率成分、能量分布 |
| **计算速度** | 快（直接计算） | 慢（需要FFT） |
| **疲劳监测** | 中等（RMS下降） | 优秀（MDF/MNF下降明显） |
| **手势识别** | 好（80%） | 中等（75%） |
| **组合使用** | ✅ 推荐时频联合（85-95%） |
| **实时性** | 优秀 | 良好 |
| **抗噪声** | MAV/RMS好 | MDF比MNF好 |

**最佳实践**：
- 实时系统：以时域为主，加1-2个关键频域特征（MNF）
- 科研分析：时频联合，提取所有18个特征
- 疲劳监测：必须用MDF/MNF
- 假肢控制：时域为主（响应快）

---

## 🚀 下一步学习

1. **时频域特征（Week 9）**
   - 小波包分解
   - 希尔伯特-黄变换
   - 经验模态分解（EMD）

2. **深度学习特征（Week 10+）**
   - CNN自动提取特征
   - LSTM处理时序信号
   - 自编码器降维

3. **实时实现（嵌入式）**
   - ARM Cortex-M4的FFT优化
   - 定点数运算
   - 功耗优化

恭喜你掌握了频域特征！你已经具备了完整的EMG信号分析能力！💪
